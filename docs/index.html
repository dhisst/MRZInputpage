<!doctype html>
<html lang="ja">

<head>
  <title>Creating Prometric ID</title>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <link href="Content/bootstrap-icons-1.11.3/font/bootstrap-icons.css" rel="stylesheet">
  <link href="css/bootstrap.min.v5.3.0.css" rel="stylesheet">
  <link href="css/style_pr_responsive.css" rel="stylesheet">
  <style>
    :root {
      --fg: #14171a;
      --bg: #fafafa;
      --card: #fff;
      --line: #e5e7eb;
      --focus: #ffa702;
      --ok: #1b5e20;
      --warn: #8a4b00;
      --err: #b00020;
      --mono: ui-monospace, "JetBrains Mono", "Roboto Mono", monospace;
      --keypad-bg: #eef6ff;
      --progress-start: #2e7d32;
      --progress-end: #66bb6a;
      --input-border: #b7dcff;
      --input-font-size: 18px;
      --input-pad-y: 8px;
      --input-pad-x: 12px;
      --mrz-letter-spacing: 2.35px;
      --sample-pre-font-size: 14px;
      --sample-code-font-size: 20px;
      --sample-code-letter-spacing: 2.35px;
      --sample-note-font-size: 11px;
      --key-min-height: 46px;
      --key-font-size: 18px;
      --error-slot-min-height: 60px;
      --keypad-switch-font-size: 14px;
      --keypad-switch-scale: 1;
      --keypad-switch-track-width: 42px;
      --keypad-switch-track-height: 24px;
      --count-font-size: 13px;
      --count-padding-y: 2px;
      --count-padding-x: 10px;
  --label-title-font-size: clamp(14px, 3.6vw, 20px);
      --check-btn-font-size: 12px;
      --check-btn-padding-y: 6px;
      --check-btn-padding-x: 12px;
      --check-btn-radius: 8px;
  --result-font-size: 13px; /* responsive base for Line1/Line2 result boxes */
    }

    * {
      box-sizing: border-box;
    }

    h1 {
      font-size: 20px;
      margin: 8px 0 12px;
    }

    label {
      display: flex;
      justify-content: flex-start;
      gap: 8px;
      font-size: 14px;
      color: #555;
      margin: 4px 0 6px;
    }

    .label-title {
      font-weight: 600;
      color: #000;
      font-size: var(--label-title-font-size);
    }

    .countwrap {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 6px;
    }

    .count {
      font-size: var(--count-font-size);
      font-family: var(--mono);
      background: #eef2ff;
      color: #1e3a8a;
      padding: var(--count-padding-y) var(--count-padding-x);
      border-radius: 999px;
      line-height: 1;
      display: inline-block;
      min-width: 80px;
      text-align: center;
      letter-spacing: .5px;
      transition: background .25s, color .25s;
    }

    .count.near {
      background: #fff8e1;
      color: var(--warn);
    }

    .count.complete {
      background: #e8f5e9;
      color: var(--ok);
    }

    .badge-state {
      display: none;
      font-size: 11px;
      font-family: var(--mono);
      padding: 3px 8px;
      border-radius: 999px;
      font-weight: 600;
      line-height: 1;
      letter-spacing: .5px;
      border: 1px solid transparent;
    }

    .badge-valid {
      background: #e8f5e9;
      color: var(--ok);
      border-color: #c8e6c9;
    }

    .badge-error {
      background: #ffebee;
      color: var(--err);
      border-color: #ffcdd2;
    }

    .badge-state.show {
      display: inline-block;
    }


    .guideline {
      position: relative;
    }

    /* Unified input style (Line1 now matches Line2 design) */
    input[type=text] {
      width: 100%;
      border: 2px solid #bfd1fc; /* match l2-input */
      border-radius: 10px;
      font-size: var(--input-font-size);
      background: #fff;
      transition: border-color .15s, box-shadow .15s;
    }

  /* Shared padding class for all text inputs */
  .input-base { padding: var(--input-pad-y,10px) var(--input-pad-x,12px); }

    input.mono {
      font-family: var(--mono);
      font-variant-numeric: slashed-zero;
      letter-spacing: var(--mrz-letter-spacing);
    }

    .mrz-line {
      padding-right: 42px;
    }

    input:focus {
      outline: none;
      border-color: #2563eb; /* unify with Line2 builder */
      box-shadow: 0 0 0 3px rgba(37,99,235,.25);
    }

    .valid-large {
      width: 30px;
      height: 30px;
      margin-left: 8px;
      display: none;
      align-items: center;
      justify-content: center;
    }

    .valid-large.show {
      display: inline-flex;
    }

    .actionRow {
      display: flex;
      align-items: center;
      gap: 12px;
      margin-top: 6px;
    }
  /* Line1 行動列: Confirm Line 1 ボタンを右端に寄せる */
  .actionRow .btn-check-line { margin-left:auto; }
  .step-title { font-size:16px; font-weight:600; margin:12px 0 4px; color:#1e3a8a; }
  .result-title { font-size:16px; font-weight:700; margin:4px 0 8px; color:#0f3a6d; position:relative; padding-left:14px; }
  @media (max-width:560px){ .result-title { font-size:18px; } }
  @media (min-width:960px){ .result-title { font-size:20px; } }
  .result-title::before { content:""; position:absolute; left:0; top:50%; transform:translateY(-50%); width:6px; height:70%; background:#2563eb; border-radius:3px; }
  .result-title i.bi { margin-right:6px; color:#2563eb; font-size:1.05em; vertical-align:middle; }
  .result-title-row { display:flex; align-items:center; gap:12px; margin:5px 0 8px; }
  .result-title-row .btn-check-line { margin-left:auto; }
  /* Message icon (embedded inside status/error areas) */
  .msg-icon { display:inline-block; margin-right:6px; vertical-align:middle; }
  .msg-icon i { font-size:20px; line-height:1; }
  /* Line1 error container flex when not empty */
  .tiny.err:not(:empty) { display:flex; align-items:flex-start; gap:6px; }
  .tiny.err:not(:empty) .errorlist { margin:0; padding-left:16px; }
  /* Neutral guidance message style */
  .tiny.err.neutral { display:block; background:#ffffff; color:#062857; padding:8px 10px; border-radius:0; font-size:12px; margin:5px 0}
  .tiny.err.neutral:not(:empty){ background:#ffffff; }
  @media (min-width:640px){ .tiny.err.neutral { font-size:13px; } }

  .btn-check-line {
      padding: var(--check-btn-padding-y) var(--check-btn-padding-x);
      font-size: var(--check-btn-font-size);
      line-height: 1.1;
      border-radius: var(--check-btn-radius);
      border: 1px solid var(--line);
      background: #fff;
      cursor: pointer;
      transition: background .18s, border-color .18s, color .18s;
    }
  /* Bigger confirm buttons (responsive) */
  .btn-confirm { font-size:calc(var(--check-btn-font-size) + 1px); padding:8px 16px; border-radius:10px; font-weight:600; }
  @media (max-width:640px){ .btn-confirm { width:100%; display:block; margin-top:0; } }

    .btn-check-line:disabled {
      opacity: .45;
      cursor: not-allowed;
    }

    .btn-check-line:not(:disabled) {
      background: #166534;
      border-color: #166534;
      color: #fff;
    }

    .btn-check-line:not(:disabled):hover {
      background: #14532d;
      border-color: #14532d;
    }

    .btn-check-line:not(:disabled):active {
      background: #0f3f22;
      border-color: #0f3f22;
    }
  /* Center alignment for Confirm Line 2 button */
  .center-l2-btn { display:block; margin:8px auto 8px;  width:100%; }
  @media (max-width:640px){ .center-l2-btn { width:100%; margin-top:6px; } }
  /* Center alignment for Confirm Line 1 button */
  .center-l1-btn { display:block; margin:8px auto 8px; width:100%; }
  @media (max-width:640px){ .center-l1-btn { width:100%; margin-top:6px; } }

    .btn-clear-line {
      padding: 6px 12px;
      font-size: 12px;
      border-radius: 8px;
      background: #f1f5f9; /* base gray */
      border: 1px solid #cbd5e1; /* subtle border */
      color: #475569; /* slate text */
      font-weight: 600;
      transition: background .15s, border-color .15s, color .15s;
    }

    .btn-clear-line:hover {
      background: #e2e8f0; /* slightly darker */
      border-color: #94a3b8;
    }

    .btn-clear-line:active {
      background: #cbd5e1; /* pressed */
      border-color: #64748b;
      color:#1e293b;
    }

    .actions {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      align-items: center;
      margin-top: 10px;
      justify-content: flex-end;
    }
  .wizard-top-bar { display:flex; gap:18px; flex-wrap:wrap; margin-bottom:0px; }
  .wizard-top-bar .wizard-steps-nav { display:flex; gap:12px; margin:0px; }
  .wizard-top-bar #keypadSwitchWrap { margin-left:auto; display:flex; align-items:center; gap:8px; padding-left:8px; }
  /* Mobile responsive adjustments for form-switch (keypad toggle) */
  @media (max-width:560px){
  .wizard-top-bar #keypadSwitchWrap { gap:6px; padding-left:4px; }
    #keypadSwitchWrap .form-check-input { width:46px; height:26px; }
    #keypadSwitchWrap .form-check-label { font-size:2.4rem; }
    #keypadSwitchWrap .form-check-label i.bi-keyboard { transform:scale(.85); }
  }
  /* Sample/Guide toggle button (shared with version1) */
  .btn-sample-toggle {
    background: #fff7ed; /* light orange */
    border: 1px solid #fdba74; /* orange border */
    color: #c2410c;
    font-weight: 600;
    padding: 6px 10px;
    font-size: 12px;
    line-height: 1;
    border-radius: 8px;
    transition: background .15s, border-color .15s, color .15s;
  }
  .btn-sample-toggle:hover { background:#ffedd5; border-color:#fb923c; }
  .btn-sample-toggle:active { background:#fdba74; border-color:#f97316; color:#7c2d12; }
  @media (max-width:400px){
    #keypadSwitchWrap .form-check-input { width:42px; height:24px; }
    #keypadSwitchWrap .form-check-label { font-size:2.2rem; }
  }
  /* Step buttons: 3 patterns current / ready / disabled */
  .wiz-step-btn { padding:10px 18px; font-weight:600;  border-top-left-radius: 10px;border-top-right-radius: 10px; cursor:pointer; transition:.18s background, .18s color, .18s border-color; }
  .wiz-step-btn.current { background:#1d4ed8; color:#fff; border:2px solid #1d4ed8; }
  .wiz-step-btn.ready { background:#e0f3ff; color:#1d4ed8; border:2px solid #1d4ed8;border-bottom: 0;}
  .wiz-step-btn.ready:hover { background:#00154e; border-color:#1d4ed8; color:#ffffff; }
  .wiz-step-btn:disabled, .wiz-step-btn.disabled { background:#334155; color:#fff; border:2px solid #334155; cursor:not-allowed; opacity:.55; }
  .wiz-step-btn:focus-visible { outline:3px solid rgba(29,78,216,.45); outline-offset:2px; }
  /* Mobile: keep in single row */
  @media (max-width:560px){
    .wizard-top-bar { flex-wrap:nowrap; gap:8px; }
    .wizard-top-bar h2 { flex:1 1 auto; font-size:15px; line-height:1.25; margin:0; }
    .wizard-top-bar .wizard-steps-nav { flex:0 0 auto; display:flex; gap:6px; margin:2px 0 0; }
  }
  @media (max-width:400px){
    .wizard-top-bar .wizard-steps-nav { margin:0; gap:4px; }
    .wizard-top-bar .wiz-step-btn { padding:5px 6px; font-size:14px; }
  .wizard-top-bar #keypadSwitchWrap { flex:0 0 auto; gap:4px; transform:scale(.85); transform-origin:right center; padding-left:2px; }
  }
  /* Keypad icon responsive sizes (base ~ desktop) */
  /* Responsive keypad label: fluid scale with clamp */
  .wizard-top-bar #keypadSwitchWrap .form-check-label { 
    font-size: clamp(2.0rem, 1.6rem + 2.5vw, 3.0rem); 
    margin-left:4px; line-height:1; display:flex; align-items:center; 
    transition: font-size .25s ease; 
  }
  /* Fine-tune very small screens */
  @media (max-width:420px){ .wizard-top-bar #keypadSwitchWrap .form-check-label { font-size: clamp(1.8rem, 1.5rem + 3vw, 2.4rem); } }
  /* Large desktop refinement */
  @media (min-width:1280px){ .wizard-top-bar #keypadSwitchWrap .form-check-label { font-size:3.2rem; } }
  .wizard-top-bar #keypadSwitchWrap .form-check-label i.bi-keyboard { 
    transform: scale(.9); 
  }

    #keypadSwitchWrap {
      margin-left: auto;
      display: flex;
      align-items: center;
      gap: 8px;
    }
  /* Override external .form-check margin-bottom for keypad toggle only */
  #keypadSwitchWrap.form-check { margin-bottom:0 !important; }

  #keypadSwitchWrap .form-check-label { font-weight:600; user-select:none; margin-left:8px; }

    #keypadSwitchWrap .form-check-input {
      width: var(--keypad-switch-track-width);
      height: var(--keypad-switch-track-height);
      margin: 0;
      transform: scale(var(--keypad-switch-scale));
      transform-origin: left center;
      cursor: pointer;
    }

    #keypadSwitchWrap .form-check-input:focus {
      box-shadow: 0 0 0 .25rem rgba(255, 167, 2, .35);
    }

    .tiny {
      font-size: 12px;
      color: #666;
    }

    .status {
      margin-top: 10px;
      padding: 10px 12px;
      border-radius: 10px;
      font-size: 14px;
      border: 1px solid var(--line);
    }

    .ok {
      background: #e8f5e9;
      color: var(--ok);
      border-color: #c8e6c9;
    }

    .warn {
      background: #fff8e1;
      color: var(--warn);
      border-color: #ffe0b2;
    }

    .err {
      background: #ffebee;
      color: var(--err);
      border-color: #ffcdd2;
    }

    .tiny.err {
      display: block;
      background: transparent;
      border: none;
      padding: 0;
    }

    .tiny.err:not(.neutral):not(:empty) {
      background: #ffebee;
      padding: 6px 8px;
      margin: 5px 0;
      border-radius: 0;
    }

    .tiny.err:empty {
      visibility: hidden;
    }

  .tiny.err .errorlist {
      list-style: disc;
      margin: 0;
      padding: 0 0 0 18px;
      font-size: 12px;
      color: var(--err);
      line-height: 1.35;
    }
  @media (min-width:480px){ .tiny.err .errorlist { font-size:12.5px; } }
  @media (min-width:640px){ .tiny.err .errorlist { font-size:13px; } }
  @media (min-width:960px){ .tiny.err .errorlist { font-size:13.5px; } }

    .tiny.err .errorlist li {
      margin: 2px 0;
      padding: 0;
      list-style: disc;
      word-break: break-word;
    }

    /* MRZ input wrapper (moved from inline style) */
    .mrz-wrapper {
      padding: 10px;
      border: 2px solid #929292;
      border-radius: 0;
      border-color: #1d4ed8;
    }

    .mrz02-wrapper {
      padding: 10px;
      border: 2px solid #929292;
      border-radius: 0;
      border-color: #1d4ed8;      
    }
  /* Wizard styles */
  .wizard-steps-nav { display:flex; gap:10px; margin:0; flex-wrap:wrap; }
  .wizard-steps-nav button { background:#0f172a; color:#fff; border:none; padding:10px 18px; font-size:20px; cursor:pointer; position:relative; font-weight:600; box-shadow:none; }
  .wizard-steps-nav button.current { background:#1d4ed8; box-shadow:none; }
  .wizard-steps-nav button:disabled { opacity:.45; cursor:not-allowed; }
  .wizard-step { display:none; animation:fadeIn .25s ease; }
  .wizard-step.active { display:block; }
  @keyframes fadeIn { from{opacity:0; transform:translateY(6px);} to {opacity:1; transform:translateY(0);} }
  .wizard-actions { margin:30px 0 10px; display:flex; gap:12px; flex-wrap:wrap; }
  .wizard-actions button { background:#0f172a; color:#fff; border:1px solid #1e293b; padding:12px 20px; border-radius:12px; font-size:15px; cursor:pointer; }
  .wizard-actions button:disabled { opacity:.45; cursor:not-allowed; }
  .wizard-actions button:focus-visible { outline:2px solid #2563eb; outline-offset:2px; }

    /* Line 2 builder (scoped styles) */
    .mrz02-wrapper .l2-card {
      background: #fff;
      border: 1px solid #e5e7eb;
      border-radius: 14px;
      padding: 16px;
    }
    .mrz02-wrapper .l2-row {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 12px;
      margin-bottom: 16px; /* base spacing between rows */
    }
    @media (min-width:640px){
      .mrz02-wrapper .l2-row { margin-bottom: 20px; }
    }
    @media (min-width:960px){
      .mrz02-wrapper .l2-row { margin-bottom: 24px; }
    }
    .mrz02-wrapper .l2-row:last-of-type { margin-bottom: 8px; }
    @media (max-width:720px) {
      .mrz02-wrapper .l2-row { grid-template-columns: 1fr; }
    }
    .mrz02-wrapper label.l2-label {
      display: flex;
      gap: 8px;
      font-size: .78rem; /* base mobile */
      line-height:1.25;
      color: #475569;
      margin: 0 0 6px;
      font-weight:600;
    }
    @media (min-width:480px){
      .mrz02-wrapper label.l2-label { font-size:.82rem; }
    }
    @media (min-width:640px){
      .mrz02-wrapper label.l2-label { font-size:.9rem; }
    }
    @media (min-width:960px){
      .mrz02-wrapper label.l2-label { font-size:1rem; }
    }
  .mrz02-wrapper label.l2-label .req { color:#dc2626; font-weight:700; margin-left:4px; }
  .mrz02-wrapper label.l2-label .hint-inline { margin-left:auto; color:#64748b; font-weight:500; }
    .mrz02-wrapper .l2-input {
      width: 100%;
      border: 2px solid #bfd1fc; /* match text input */
      border-radius: 10px;
      font-size: var(--input-font-size);
      background: #fff;
    }
    /* Normalize select & date inside l2-input to match text input vertical rhythm */
    .mrz02-wrapper select.l2-input.input-base,
    .mrz02-wrapper input[type=date].l2-input.input-base {
      line-height:1.2; /* keep consistent */
    }
    .mrz02-wrapper select.l2-input.input-base { /* minimal: unify vertical size with text inputs */
      -webkit-appearance:none; appearance:none;
      background:#fff;
      line-height:1.2;
      min-height: calc(var(--input-font-size) + var(--input-pad-y) * 2 + 4px);
      cursor:pointer;
    }
  /* Removed per unified font-size strategy; rely on :root variable overrides */
    .mrz02-wrapper .l2-input:focus {
      outline: none;
      border-color: #2563eb;
      box-shadow: 0 0 0 3px rgba(37,99,235,.25);
    }
  .mrz02-wrapper .l2-passno-wrap { display:flex; gap:6px; align-items:stretch; }
  .mrz02-wrapper .l2-passno-wrap .l2-cd { flex:0 0 42px; /* padding removed -> use .input-base */ border:1px solid #e2e8f0; border-radius:10px; background:#f1f5f9; font-size:var(--input-font-size); font-family:var(--mono); text-align:center; font-weight:600; letter-spacing:.5px; }
  /* Removed l2-cd media query font-size overrides; now follows --input-font-size */
  .mrz02-wrapper .l2-passno-wrap .l2-cd.ready { background:#dbeafe; border-color:#bfdbfe; color:#1e3a8a; }
  .mrz02-wrapper .l2-field-wrap { display:flex; gap:6px; align-items:stretch; }
  .mrz02-wrapper .l2-field-wrap .l2-cd { flex:0 0 42px; /* padding removed -> use .input-base */ border:1px solid #e2e8f0; border-radius:10px; background:#f1f5f9; font-size:var(--input-font-size); font-family:var(--mono); text-align:center; font-weight:600; letter-spacing:.5px; }
  .mrz02-wrapper .l2-field-wrap .l2-cd.ready { background:#dbeafe; border-color:#bfdbfe; color:#1e3a8a; }
  /* Optional auto text display */
  .mrz02-wrapper .opt-auto { display:flex; align-items:center; min-height:40px; border:1px solid #f1f5f9; background:#f1f5f9; color:#475569; }
    .mrz02-wrapper .l2-hint {
      font-size: .68rem;
      color: #64748b;
      margin-top: 4px;
      min-height: 18px;
      word-break: break-word;
    }
    .mrz02-wrapper .l2-monobox {
      font-family: var(--mono);
      font-variant-numeric: slashed-zero;
      letter-spacing: .5px;
      background: #0f172a;
      color: #ffffff;
      border: 1px solid #1e293b;
      border-radius: 10px;
      padding: 8px 12px;
      white-space: pre;
      overflow-x: auto;
      margin-top: 8px;
      font-size: var(--result-font-size);
    }
  .mrz02-wrapper .cd-note { font-size:.65rem; color:#64748b; margin:4px 2px 0; line-height:1.3; }
  @media (min-width:480px){ .mrz02-wrapper .cd-note { font-size:.7rem; } }
  @media (min-width:640px){ .mrz02-wrapper .cd-note { font-size:.75rem; } }
  @media (min-width:960px){ .mrz02-wrapper .cd-note { font-size:.8rem; } }
    /* Line1 preview box (match Line2 dark style) */
  .mrz02-wrapper .l2-cd-mark { color:#facc15; }
    .mrz02-wrapper .l2-status {
      margin-top: 12px;
      padding: 10px 12px;
      border-radius: 0; /* remove rounded corners per request */
      font-size: .7rem;
    }
    @media (min-width:480px){ .mrz02-wrapper .l2-status { font-size:.74rem; } }
    @media (min-width:640px){ .mrz02-wrapper .l2-status { font-size:.78rem; } }
    @media (min-width:960px){ .mrz02-wrapper .l2-status { font-size:.82rem; } }
  .mrz02-wrapper .l2-status.ok { background: #e8f5e9; color: #2e7d32; }
  .mrz02-wrapper .l2-status.warn { background: #fff3e0; color: #e65100; }
  .mrz02-wrapper .l2-status.err { background: #ffebee; color: #c62828; }
  /* Line1 status (same design as Line2) */
  .l1-status { margin-top:5px; padding:6px 8px; font-size:.7rem; }
  @media (min-width:480px){ .l1-status { font-size:.74rem; } }
  @media (min-width:640px){ .l1-status { font-size:.78rem; } }
  @media (min-width:960px){ .l1-status { font-size:.82rem; } }
  .l1-status.ok { background:#e8f5e9; color:#2e7d32; }
  .l1-status.warn { background:#fff3e0; color:#e65100; }
  .l1-status.err { background:#ffebee; color:#c62828; }
  /* Removed old Line2 specific error styles; unified with Line1 .errorlist under .tiny.err */
  .mrz02-wrapper .l2-hinttext { margin:6px 0 0 0; color:#475569; font-size:.68rem; line-height:1.35; }
  /* Check digit inline label */
  .mrz02-wrapper .l2-label .cd-label { margin-left:auto; font-weight:600; color:#475569; font-size:.65rem; letter-spacing:.4px; display:inline-block; }
    .mrz02-wrapper .l2-actions { display: flex; flex-wrap: wrap; gap: 8px; margin-top: 10px; }
    .mrz02-wrapper .l2-btn {
      padding: 6px 10px;
      border: 1px solid #e5e7eb;
      border-radius: 8px;
      background: #fff;
      cursor: pointer;
      font-size: .65rem;
      line-height: 1;
      letter-spacing: .5px;
    }
    .mrz02-wrapper .l2-btn:focus-visible { outline: 2px solid #2563eb; outline-offset: 2px; }
    .mrz02-wrapper details.l2-details { margin-top: 8px; }
    .mrz02-wrapper details.l2-details summary { cursor: pointer; font-size: .65rem; color: #64748b; }

    .keypad {
      position: sticky;
      bottom: 0;
      background: var(--keypad-bg);
      border: 3px solid #202175;
      margin-top: 12px;
      z-index: 10;
      transition: transform .28s ease, opacity .28s ease;
      box-shadow: 0 6px 6px rgba(0, 0, 0, .40), 0 0 0 1px rgba(0, 0, 0, .20);
    }

    .keypad.hide {
      pointer-events: none;
      opacity: 0;
      transform: translateY(12px);
    }

    .keys {
      display: grid;
      grid-template-columns: repeat(10, 1fr);
      gap: 0;
    }

    .break {
      grid-column: 1 / -1;
      height: 0;
    }

    .key {
      min-height: var(--key-min-height);
      border: 1px solid #4a4a4a;
      background: #fff; /* base, will be overridden for alphanumeric gradient */
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--mono);
      font-size: var(--key-font-size);
      font-weight: 500;
      user-select: none;
      cursor: pointer;
      touch-action: manipulation;
      transition: background .12s, border-color .12s;
    }

    /* 英数字キー（data-action未指定）用: 微グラデーション */
    .key:not([data-action]) {
      background: linear-gradient(#ffffff, #f2f7fc); /* subtle top->bottom */
    }

    /* ホバー時は既存と同じ濃青、activeは薄グレーで統一 */

    .key:hover {
      background: #07427c;
      color: #fff;
    }

    .key:active {
      background: #e2e8f0;
    }

    .key:focus-visible {
      outline: 2px solid var(--focus);
      outline-offset: 2px;
    }

    .key[data-action] {
      font-size: var(--key-font-size);
      font-weight: 600;
      letter-spacing: .5px;
    }

    .key[data-action=back],
    .key[data-action=clearL1] {
      background: linear-gradient(#fff5f5, #ffe4e6);
      border-color: #4a4a4a; /* 英数字と同じ */
      color: #b91c1c;
    }

    /* backspace hover: 濃い赤背景＋白文字＋同色ボーダー */
    .key[data-action=back]:hover {
      background: #7f1d1d; /* dark red */
      color: #fff;
      border-color: #7f1d1d;
    }
    /* clearL1 は従来どおり淡赤グラデーション */
    .key[data-action=clearL1]:hover {
      background: linear-gradient(#fff1f2, #ffd9de);
    }

    .key[data-action=back]:active,
    .key[data-action=clearL1]:active {
      background: #fecdd3;
    }

    .key[data-action=fillpad],
    .key[data-action=lt] {
      background: linear-gradient(#e8f5e9, #d0f1d4);
      border-color: #4a4a4a; /* 英数字と同じ */
      color: #1b5e20;
    }

    /* FILL< / < hover: 濃い緑背景＋白文字＋同色ボーダー */
    .key[data-action=fillpad]:hover,
    .key[data-action=lt]:hover {
      background: #14532d; /* dark green */
      color: #fff;
      border-color: #14532d;
    }

    .key[data-action=fillpad]:active,
    .key[data-action=lt]:active {
      background: #b2e2b8;
    }

    .key[data-action=clear] {
      background: linear-gradient(#fefce8, #fef9c3);
      border-color: #fde68a;
      color: #92400e;
    }

    .key[data-action=clear]:hover {
      background: linear-gradient(#fef9d8, #fef3a8);
    }

    .key[data-action=clear]:active {
      background: #fde68a;
    }

    .key svg.bi {
      width: 1.4em;
      height: 1.4em;
      display: block;
    }

    .key--span2 {
      grid-column: span 2;
    }

    .key--span3 {
      grid-column: span 3;
    }

    .key--span4 {
      grid-column: span 4;
    }

    .key--span10 {
      grid-column: 1 / -1;
    }

    .key.wide {
      grid-column: span 2;
    }

    .key.widewide {
      grid-column: span 4;
    }

    .sample-box {
      margin-top: 0;
      font-size: 13px;
      color: #1e3a8a;
    }

    .sample-note {
      margin: 4px 0;
      font-size: var(--sample-note-font-size);
      color: #475569;
      line-height: .9rem;
    }

    .sample-box pre {
      margin: 6px 0;
      font: var(--sample-pre-font-size)/1.15 var(--mono);
      background: #0f172a;
      color: #e2e8f0;
      padding: 10px 12px;
      border-radius: 10px;
      overflow-x: auto;
    }

    .sample-box code {
      display: block;
      white-space: pre;
      font-family: var(--mono);
      font-size: var(--sample-code-font-size);
      letter-spacing: var(--sample-code-letter-spacing);
      min-width: 44ch;
    }

    #sampleBoxBody pre {
      margin: 6px 0;
      font: var(--sample-pre-font-size)/1.15 var(--mono);
      background: #7b7b7b;
      color: #ffffff;
      padding: 10px 8px;
      border-radius: 10px;
      overflow-x: auto;
    }

    #sampleBoxBody code {
      display: block;
      white-space: pre;
      font-family: var(--mono);
      font-size: var(--sample-code-font-size);
      letter-spacing: var(--sample-code-letter-spacing);
      min-width: 44ch;
    }

    /* Line2 sample styling (match Line1) */
  #sampleBoxBody2 pre,
  #samplePassnoBody pre,
  #sampleNatBody pre {
      margin: 6px 0;
      font: var(--sample-pre-font-size)/1.15 var(--mono);
      background: #7b7b7b;
      color: #ffffff;
      padding: 10px 8px;
      border-radius: 10px;
      overflow-x: auto;
    }
  #sampleBoxBody2 code,
  #samplePassnoBody code,
  #sampleNatBody code {
      display: block;
      white-space: pre;
      font-family: var(--mono);
      font-size: var(--sample-code-font-size);
      letter-spacing: var(--sample-code-letter-spacing);
      min-width: 44ch;
    }

    @media (max-width:599px) {
      :root {
        --input-font-size: 16px;
        --sample-note-font-size: 10.5px;
        --sample-code-font-size: 13px;
        --sample-code-letter-spacing: .25px;
        --key-min-height: 50px;
        --key-font-size: 16px;
        --error-slot-min-height: 52px;
        --label-title-font-size: 16px;
  --result-font-size: 12.5px;
      }
    }

    @media (max-width:430px) {
      :root {
        --input-font-size: 15px;
        --mrz-letter-spacing: 0;
        --sample-code-font-size: 13px;
        --sample-code-letter-spacing: 0;
        --sample-note-font-size: 10px;
        --key-min-height: 48px;
        --key-font-size: 15px;
        --error-slot-min-height: 50px;
        --label-title-font-size: 15px;
        --result-font-size: 12px;
      }

  .input-base { padding: 6px 6px; }
    }

    @media (max-width:380px) {
      :root {
        --input-font-size: 13px;
        --mrz-letter-spacing: 0;
        --sample-code-font-size: 13px;
        --sample-code-letter-spacing: 0;
        --sample-note-font-size: 9.5px;
        --key-min-height: 44px;
        --key-font-size: 18px;
        --error-slot-min-height: 48px;
        --label-title-font-size: 14px;
        --result-font-size: 11px;
      }

  .input-base { padding: 4px 4px; }
    }

    @media (min-width:480px) {
      :root {
        --count-font-size: 14px;
        --count-padding-y: 3px;
        --count-padding-x: 12px;
        --keypad-switch-font-size: 15px;
        --keypad-switch-scale: 1.06;
  --result-font-size: 14px;
      }
    }

    @media (min-width:640px) {
      :root {
        --count-font-size: 15px;
        --count-padding-y: 4px;
        --count-padding-x: 14px;
        --keypad-switch-font-size: 16px;
        --keypad-switch-scale: 1.12;
  --result-font-size: 15px;
      }
    }

    @media (min-width:840px) {
      :root {
        --count-font-size: 16px;
        --count-padding-y: 5px;
        --count-padding-x: 16px;
        --keypad-switch-font-size: 16px;
        --keypad-switch-scale: 1.16;
        --result-font-size: 24.0px;
      }
    }

    @media (min-width:1024px) {
      :root {
        --count-font-size: 17px;
        --count-padding-y: 6px;
        --count-padding-x: 18px;
        --keypad-switch-font-size: 17px;
        --keypad-switch-scale: 1.20;
        --result-font-size: 30px;
      }
    }

    @media (min-width:1280px) {
      :root {
        --count-font-size: 18px;
        --count-padding-y: 7px;
        --count-padding-x: 20px;
        --keypad-switch-font-size: 18px;
        --keypad-switch-scale: 1.25;
        --result-font-size: 30px;
      }
    }

    @media (min-width:480px) {
      :root {
        --check-btn-font-size: 13px;
        --check-btn-padding-y: 7px;
        --check-btn-padding-x: 14px;
      }
    }

    @media (min-width:640px) {
      :root {
        --check-btn-font-size: 14px;
        --check-btn-padding-y: 8px;
        --check-btn-padding-x: 16px;
      }
    }

    @media (min-width:840px) {
      :root {
        --check-btn-font-size: 15px;
        --check-btn-padding-y: 9px;
        --check-btn-padding-x: 18px;
        --check-btn-radius: 9px;
      }
    }

    @media (min-width:1024px) {
      :root {
        --check-btn-font-size: 20px;
        --check-btn-padding-y: 10px;
        --check-btn-padding-x: 20px;
        --check-btn-radius: 10px;
      }
    }

    @media (min-width:1280px) {
      :root {
        --check-btn-font-size: 20px;
        --check-btn-padding-y: 11px;
        --check-btn-padding-x: 22px;
        --check-btn-radius: 11px;
      }
    }

    @media (min-width:600px) {
      :root {
        --input-font-size: 16px;
        --key-min-height: 50px;
        --key-font-size: 18px;
        --error-slot-min-height: 60px;
      }
    }

    @media (min-width:900px) {
      :root {
        --input-font-size: 20px;
        --sample-pre-font-size: 20px;
        --sample-code-font-size: 20px;
        --sample-code-letter-spacing: 4px;
        --sample-note-font-size: 16px;
        --key-min-height: 50px;
        --key-font-size: 20px;
        --error-slot-min-height: 72px;
      }

      .sample-box pre {
        padding: 12px 14px;
      }
    }

    @media (prefers-reduced-motion:reduce) {

      .btn:active,
      .key:active {
        transform: none;
      }
    }

    .state-icon-wrap{ display:inline-flex; align-items:center; justify-content:center; width:20px; height:20px; border-radius:50%; background:#16a34a; color:#fff; font-size:14px; line-height:1; }
    .state-icon-wrap.err{ background:#dc2626; }
    .state-icon-wrap .bi{ color:#fff !important; font-size:16px; }
  </style>
</head>

<body>
  <div class="container-fluid custom-header">
    <div class="container d-flex"><img src="Content/images/prometric_logo.svg" alt="Prometricのロゴ"
        class="custom-header-logo" /></div>
  </div>
  <div class="title-default-block">
    <h1>Creating Prometric ID</h1>
  </div>
  <div class="container-fluid page-wrapper">
          <h2>Enter your passport information</h2>
        <div class="wizard-top-bar">
      <div class="wizard-steps-nav" aria-label="MRZ wizard step navigation">
        <button type="button" class="wiz-step-btn current" data-step="1" aria-controls="step1" aria-selected="true">MRZ Line 1 <span id="step1State" aria-hidden="true"></span></button>
  <button type="button" class="wiz-step-btn" data-step="2" aria-controls="step2" aria-selected="false">MRZ Line 2 <span id="step2State" aria-hidden="true"></span></button>
      </div>
  <div class="form-check form-switch" id="keypadSwitchWrap"><input class="form-check-input" type="checkbox" role="switch" id="toggleKeypad" aria-label="キーパッド切替"><label class="form-check-label" for="toggleKeypad"><i class="bi bi-keyboard" aria-hidden="true"></i></label></div>
    </div>
    <div id="step1" class="wizard-step active" aria-labelledby="step1Heading">
      <div class="mrz-wrapper">
          <section>
            <div class="row">
              <div>
        <label for="line1"><span class="label-title" aria-label="MRZ Line 1 input">MRZ Line 1</span> <button type="button" class="btn btn-sample-toggle"
          id="toggleSample" aria-controls="sampleBoxBody" aria-expanded="false">Show
          sample</button> <span class="countwrap"><span id="l1valid" class="badge-state badge-valid"
                      aria-hidden="true">VALID</span><span id="l1count" class="count">0 / 44</span></span></label>
                <div id="sampleBoxBody" hidden aria-hidden="true">
                  <pre><code id="sampleL1">P&lt;MMRSHIKEN&lt;&lt;TARO&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;&lt;</code></pre>
                  <p class="sample-note">Positions: 1-2 Document Type, 3-5 Issuing Country, 6-44 Name</p>
                </div>
  <div class="guideline"><input id="line1" class="mono mrz-line input-base" type="text" inputmode="latin"
    autocomplete="off" autocapitalize="off" spellcheck="false" maxlength="44"></div>
  <div id="statusA" class="l1-status" aria-live="polite" hidden></div>
  <div class="l1-msg-row" style="display:flex; align-items:flex-start; gap:12px; margin-top:4px;">
    <div id="errLine1" class="tiny err neutral" aria-live="polite" style="flex:1;">After entering, click Confirm Line 1.</div>
    <button type="button" id="clearL1Btn" class="btn btn-clear-line" aria-label="Line 1 をクリア" style="margin-left:auto;">Clear</button>
  </div>
        <div class="actionRow" style="justify-content:flex-start; margin-top:10px;">
          <button type="button" id="checkL1Btn" class="btn btn-check-line btn-confirm center-l1-btn" aria-label="Confirm Line 1">Confirm Line 1</button>
        </div>
  <!-- statusA moved above; single message zone below input now -->
              </div>
            </div>
                </section>
      </div>
          <div class="d-flex justify-content-between margin-t-large margin-b-large">
      <button class="btn btn-secondary wid-180 me-5" type="button" onclick="history.back()"><i
          class="bi bi-caret-left-fill"></i>Return</button>
  <button class="btn btn-primary wid-180" type="button" id="legacyNextStep1">MRZ Line 2<i class="bi bi-caret-right-fill"></i></button>
    </div>

    </div>
    <div id="step2" class="wizard-step" aria-labelledby="step2Heading">
      <div class="mrz02-wrapper">
        <section aria-labelledby="l2-title">
          <label for="line2"><span class="label-title" aria-label="MRZ Line 2 builder fields">MRZ Line 2</span> <span class="countwrap"><span id="l2valid" class="badge-state badge-valid" aria-hidden="true">VALID</span></span></label>
          <div class="l2-row">
            <div>
              <label for="b_passno" class="l2-label">Passport number (up to 9)<span class="req" aria-hidden="true">*</span> <span class="cd-label" aria-label="Auto check digit (will be filled)">Check digit</span></label>
              <div class="l2-passno-wrap">
                <input id="b_passno" class="l2-input mono input-base" type="text" inputmode="latin" maxlength="9" autocomplete="off" autocapitalize="off" spellcheck="false" />
                <div id="b_passno_cd" class="l2-cd input-base" aria-label="Passport number check digit" title="Auto check digit" data-empty="1">–</div>
              </div>
              <div id="err_passno" class="tiny err" aria-live="polite"></div>
            </div>
            <div>
              <label for="b_nationality" class="l2-label">Nationality (3 letters A–Z)<span class="req" aria-hidden="true">*</span> <span class="hint-inline" aria-label="3 letters A to Z"></span>
                <button type="button" class="btn btn-sample-toggle" id="toggleSampleNat" aria-controls="sampleNatBody" aria-expanded="false">Show guide</button>
              </label>
              <div id="sampleNatBody" hidden aria-hidden="true" style="margin-bottom:4px;">
                <pre><code>AB12345671<span class="l2-cd-mark">MMR</span></code></pre>
                <p class="sample-note" style="margin:4px 0 0;">Enter nationality code (MRZ Line 2 positions 11–13).</p>
              </div>
              <input id="b_nationality" class="l2-input mono input-base" type="text" inputmode="latin" maxlength="3" autocomplete="off" autocapitalize="off" spellcheck="false" />
              <div id="err_nat" class="tiny err" aria-live="polite"></div>
            </div>
          </div>
          <div class="l2-row">
            <div>
              <label for="b_dob" class="l2-label">Date of birth <span class="req" aria-hidden="true">*</span> <span class="cd-label" aria-label="Auto check digit (will be filled)">Check digit</span></label>
              <div class="l2-field-wrap">
                <input id="b_dob" class="l2-input input-base" type="date" readonly aria-label="Select date of birth from calendar" />
                <div id="b_dob_cd" class="l2-cd input-base" aria-label="DOB check digit" title="Auto DOB check digit">–</div>
              </div>
              <div id="err_dob" class="tiny err" aria-live="polite"></div>
            </div>
            <div>
              <label for="b_sex" class="l2-label">Sex <span class="req" aria-hidden="true">*</span> </label>
              <select id="b_sex" class="l2-input input-base">
                <option value="">Please select</option>
                <option value="M">Male</option>
                <option value="F">Female</option>
                <option value="<">Unspecified (X)</option>
              </select>
              <div id="err_sex" class="tiny err" aria-live="polite"></div>
            </div>
          </div>
          <div class="l2-row">
            <div>
              <label for="b_expiry" class="l2-label">Expiry date <span class="req" aria-hidden="true">*</span> <span class="cd-label" aria-label="Auto check digit (will be filled)">Check digit</span></label>
              <div class="l2-field-wrap">
                <input id="b_expiry" class="l2-input input-base" type="date" readonly aria-label="Select expiry date from calendar" />
                <div id="b_expiry_cd" class="l2-cd input-base" aria-label="Expiry check digit" title="Auto expiry check digit">–</div>
              </div>
              <div id="err_exp" class="tiny err" aria-live="polite"></div>
            </div>
            <div>
              <label class="l2-label">Optional data</label>
              <div id="b_opt" class="l2-input mono input-base opt-auto" aria-label="Optional field auto filled">Not required for ID – auto-filled with '&lt;'</div>
              <div id="err_opt" class="tiny err" aria-live="polite" hidden></div>
            </div>
          </div>
          <div class="result-title-row">
            <h4 class="result-title">MRZ Line 2 Result</h4>
          </div>
          <div id="assembledL2" class="l2-monobox" aria-live="polite" aria-label="MRZ Line 2 result">(Assembled Line 2 will appear here)</div>
          <p class="cd-note" aria-hidden="true" style="margin-bottom:4px;">Yellow characters are check digits auto-calculated.</p>
          <div id="statusB" class="l2-status warn" aria-live="polite">Waiting for input…</div>
          <button type="button" id="validateL2Btn" class="btn btn-check-line btn-confirm center-l2-btn" aria-label="Confirm Line 2">Confirm Line 2</button>
        </section>
      </div>
      <div class="d-flex justify-content-between margin-t-large margin-b-large" id="legacyNav">
        <button class="btn btn-secondary wid-180 me-5" type="button" id="legacyReturn"><i class="bi bi-caret-left-fill"></i>MRZ Line 1</button>
        <button class="btn btn-primary wid-180" type="button" id="legacyNext">Next <i class="bi bi-caret-right-fill"></i></button>
      </div>
    
    </div>
  <!-- Keypad toggle moved to top bar -->
    <div class="keypad" aria-label="MRZ keypad">
      <div class="keys" id="keypad"></div>
    </div>
  <!-- Removed old page navigation buttons (Return/Next) for wizard flow -->
  </div>
  <div class="container-fluid custom-footer">
    <footer>
      <p class="copyright-text">&copy; Prometric, ALL RIGHTS RESERVED.</p>
    </footer>
    <script src="Content/js/bootstrap.bundle.min.v5.3.0.js"></script>
  </div>
  <script>
    const W = [7, 3, 1];
    const mapVal = ch => ch === '<' ? 0 : (ch >= '0' && ch <= '9') ? ch.charCodeAt(0) - 48 : (ch >= 'A' && ch <= 'Z') ? ch.charCodeAt(0) - 55 : NaN;
    function checkDigit(str) { let s = 0; for (let i = 0; i < str.length; i++) { const v = mapVal(str[i]); if (Number.isNaN(v)) return null; s += v * W[i % 3]; } return String(s % 10); }
    function normalizeMRZ(s) { if (!s) return ''; const nfkc = s.normalize('NFKC'); const mapped = nfkc.replace(/[Ａ-Ｚａ-ｚ０-９＜]/g, ch => { const c = ch.charCodeAt(0); if (c >= 0xFF21 && c <= 0xFF3A) return String.fromCharCode(c - 0xFF21 + 65); if (c >= 0xFF41 && c <= 0xFF5A) return String.fromCharCode(c - 0xFF41 + 65); if (c >= 0xFF10 && c <= 0xFF19) return String.fromCharCode(c - 0xFF10 + 48); if (c === 0xFF1C) return '<'; return ch; }).toUpperCase().replace(/[^A-Z0-9\n<]/g, ''); return mapped; }
  function setCount(el, cnt) { const used = el.value.length; cnt.textContent = `${used} / 44`; cnt.classList.toggle('complete', used === 44); cnt.classList.toggle('near', used >= 30 && used < 44); }
  function validateLine1Only(line1, { suppressLengthErrors = false } = {}) { const errs = []; const re44 = /^[A-Z0-9<]{44}$/; if (!suppressLengthErrors && line1.length > 0 && !re44.test(line1)) errs.push('Line 1 must be 44 chars [A–Z, 0–9, <].'); if (line1.length >= 2) { const docCode = line1.slice(0, 2); if (docCode[0] !== 'P') errs.push('Expected doc code starting with "P".'); if (!/[A-Z<]/.test(docCode[1])) errs.push('Second char should be "<" or A–Z.'); if(line1.length >=5){ const issuing = line1.slice(2,5); if(!/^[A-Z]{3}$/.test(issuing)) errs.push('Issuing country must be 3 letters A–Z.'); } } return errs; }
  const line1 = document.getElementById('line1'); const l1count = document.getElementById('l1count'); const errLine1 = document.getElementById('errLine1'); const l1valid = document.getElementById('l1valid');
  // Icons now embedded inside message containers (errLine1 / statusA / statusB)
  const statusA = document.getElementById('statusA');
  // Wizard global placeholders (avoid temporal dead zone when updateA calls enableStepControls early)
  let stepButtons = [];
  let nextFromStep1;
  let backToStep1;
  let submitMrz;
  let statusB; // Line 2 status element (set inside builder IIFE)
  function enableStepControls(){
    // Guard until wizard initialized
    if(!stepButtons || stepButtons.length < 2) return;
    if(!nextFromStep1) return;
  // Line1 gating removed: Step 2 always enabled
  if(stepButtons[1].disabled) stepButtons[1].disabled = false;
  if(nextFromStep1 && nextFromStep1.disabled) nextFromStep1.disabled = false;
    // Line2
    if(submitMrz){
      if(statusB && statusB.classList && statusB.classList.contains('ok')){
        if(submitMrz.disabled) submitMrz.disabled = false;
      } else {
        if(!submitMrz.disabled) submitMrz.disabled = true;
      }
    }
  }
  function showBadge(container, type) {
    if(!container) return;
    // prepend icon span; remove any existing first icon span
    const first = container.querySelector('.msg-icon');
    if(first) first.remove();
    const iconWrap = document.createElement('span');
    iconWrap.className = 'msg-icon';
    if(type==='valid') {
      iconWrap.innerHTML = '<i class="bi bi-check-circle-fill" style="color:#16a34a" aria-label="Valid"></i>';
    } else {
      iconWrap.innerHTML = '<i class="bi bi-exclamation-circle-fill" style="color:#dc2626" aria-label="Error"></i>';
    }
    container.prepend(iconWrap);
  }
    let currentField = line1; line1.addEventListener('focus', () => { currentField = line1; });
  // Line2 builder text inputsもキーパッド対象に
  ['b_passno','b_nationality','b_opt'].forEach(id=>{ const el=document.getElementById(id); if(el){ el.addEventListener('focus',()=>{ currentField = el; }); el.addEventListener('keydown',()=>{ if(keypadMode && !isCoarse && !isTouch){ keypadMode=false; applyKeypadMode(); } }); } });
    function clean(el) { const start = el.selectionStart ?? el.value.length; const beforeLen = el.value.length; const norm = normalizeMRZ(el.value).replace(/\n/g, '').slice(0, 44); el.value = norm; const delta = el.value.length - beforeLen; const pos = Math.max(0, Math.min(el.value.length, start + delta)); try { el.setSelectionRange(pos, pos); } catch (_) { } }
    // Line1 validation control flag (Confirm button sets this true)
    let checkedL1 = false; // manual only validation gate
    // Line1 エラー保持フラグ: 一度 Confirm で表示したエラーは次の Confirm まで入力で消さない
    let line1ErrorsLocked = false;
    function updateA() {
  // A-spec: do nothing until user explicitly validates
  if(!checkedL1){ setCount(line1, l1count); if(errLine1){ errLine1.classList.add('neutral'); errLine1.textContent='After entering, click Confirm Line 1.'; } if(statusA){ statusA.textContent=''; statusA.setAttribute('hidden',''); } return; }
  setCount(line1, l1count);
      const v1 = line1.value;
      // 既存エラーをロックしている場合は内容維持（カウントのみ更新）
      if(line1ErrorsLocked){ if(typeof enableStepControls==='function') enableStepControls(); return; }
      // Line1 preview: ユーザー入力のみ表示（未入力部分の '<' パディングなし）
  // removed preview box
  if (!v1) { if(errLine1){ errLine1.classList.add('neutral'); errLine1.textContent='After entering, click Confirm Line 1.'; } return; }
  // 入力途中 (長さ不足・または成功/失敗確定前) は何もしない。Confirm時のみ検証するためここでは return。
  if(errLine1){ errLine1.classList.add('neutral'); if(!line1ErrorsLocked){ errLine1.textContent='After entering, click Confirm Line 1.'; } }
  if(statusA){ statusA.textContent=''; statusA.setAttribute('hidden',''); }
  return;
  // Wizard step control update (if function defined later)
  if(typeof enableStepControls==='function') enableStepControls();
    }
    let composing = false; function flagWrapper(ref) { return v => { if (v === true) { ref.value = true; } else if (v === false) { ref.value = false; } return ref.value; }; } const f1 = flagWrapper({ value: false }); function attach(el, setFlag) { el.addEventListener('compositionstart', () => { setFlag(true); }); el.addEventListener('compositionend', () => { setFlag(false); clean(el); updateA(); }); el.addEventListener('input', () => { if (setFlag() === 'get') return; if (!setFlag()) { clean(el); updateA(); } }); el.addEventListener('blur', () => { if (!setFlag()) { clean(el); updateA(); } }); el.addEventListener('paste', () => { setTimeout(() => { clean(el); updateA(); }, 0); }); } attach(line1, f1);
    const sampleBoxBody = document.getElementById('sampleBoxBody'); const toggleSampleBtn = document.getElementById('toggleSample'); if (toggleSampleBtn && sampleBoxBody) { toggleSampleBtn.addEventListener('click', () => { const hidden = sampleBoxBody.hasAttribute('hidden'); if (hidden) { sampleBoxBody.removeAttribute('hidden'); toggleSampleBtn.textContent = 'Hide sample'; toggleSampleBtn.setAttribute('aria-expanded', 'true'); } else { sampleBoxBody.setAttribute('hidden', ''); toggleSampleBtn.textContent = 'Show sample'; toggleSampleBtn.setAttribute('aria-expanded', 'false'); } });['sampleL1'].forEach(id => { const el = document.getElementById(id); if (!el) return; const txt = el.textContent.trim(); if (txt.length < 44) { el.textContent = txt + '<'.repeat(44 - txt.length); } }); }
  let toggleBtn; const isCoarse = window.matchMedia && window.matchMedia('(pointer: coarse)').matches; const isTouch = ('ontouchstart' in window) || (navigator.maxTouchPoints > 0); let keypadMode = true; function applyKeypadMode() { const fields=[line1, document.getElementById('b_passno'), document.getElementById('b_nationality'), document.getElementById('b_opt')].filter(Boolean); fields.forEach(inp => { if (keypadMode) { inp.setAttribute('readonly','readonly'); inp.setAttribute('inputmode','none'); inp.setAttribute('autocapitalize','off'); inp.setAttribute('autocomplete','off'); inp.setAttribute('spellcheck','false'); } else { inp.removeAttribute('readonly'); inp.setAttribute('inputmode','latin'); } }); if (toggleBtn && toggleBtn.type === 'checkbox') { toggleBtn.checked = keypadMode; } if (toggleBtn) { toggleBtn.setAttribute('aria-pressed', keypadMode ? 'true' : 'false'); } const keypadWrap = document.querySelector('.keypad'); if (keypadWrap) { if (keypadMode) { keypadWrap.classList.remove('hide'); keypadWrap.removeAttribute('aria-hidden'); } else { keypadWrap.classList.add('hide'); keypadWrap.setAttribute('aria-hidden','true'); } } }
    line1.addEventListener('keydown', () => { if (keypadMode && !isCoarse && !isTouch) { keypadMode = false; applyKeypadMode(); } });
  const keypadEl = document.getElementById('keypad'); function activeField() { return currentField || line1; } function maxLenFor(field){ const ml = parseInt(field.getAttribute('maxlength')||'44',10); return isNaN(ml)?44:ml; } function insertAtCaret(field, text) { const start = field.selectionStart ?? field.value.length; const end = field.selectionEnd ?? start; const before = field.value.slice(0, start); const after = field.value.slice(end); const limit = maxLenFor(field); let next = (before + text + after).slice(0, limit); field.value = next; const caretPos = Math.min(start + text.length, field.value.length); field.setSelectionRange(caretPos, caretPos); if(field.id!=='line1') { const evt=new Event('input',{bubbles:true}); field.dispatchEvent(evt); } } function backspaceAtCaret(field) { const start = field.selectionStart ?? field.value.length; const end = field.selectionEnd ?? start; if (start !== end) { const before = field.value.slice(0, start); const after = field.value.slice(end); field.value = (before + after); field.setSelectionRange(start, start); if(field.id!=='line1'){ field.dispatchEvent(new Event('input',{bubbles:true})); } return; } if (start === 0) return; const before = field.value.slice(0, start - 1); const after = field.value.slice(start); field.value = (before + after); field.setSelectionRange(start - 1, start - 1); if(field.id!=='line1'){ field.dispatchEvent(new Event('input',{bubbles:true})); } } function fillPad(field) { const caret = field.selectionStart ?? field.value.length; const limit = maxLenFor(field); if (field.value.length < limit) { const padCount = limit - field.value.length; field.value = field.value + '<'.repeat(padCount); } const pos = Math.min(caret, field.value.length); field.setSelectionRange(pos, pos); if(field.id!=='line1'){ field.dispatchEvent(new Event('input',{bubbles:true})); } } function makeKey(txt, opts = {}) { const b = document.createElement('button'); b.type = 'button'; b.className = 'key'; if (opts.span) { b.classList.add(`key--span${opts.span}`); } else if (opts.wide) { b.classList.add('key--span2'); } else if (opts.widewide) { b.classList.add('key--span4'); } b.textContent = txt; b.setAttribute('aria-label', opts.label || txt); if (opts.id) { b.id = opts.id; } if (opts.action) { b.dataset.action = opts.action; } b.addEventListener('pointerdown', e => { e.preventDefault(); const field = activeField(); if (opts.action === 'back') { backspaceAtCaret(field); updateA(); field.focus(); return; } if (opts.action === 'clear') { field.value = ''; field.setSelectionRange(0, 0); updateA(); field.focus(); if(field.id!=='line1'){ field.dispatchEvent(new Event('input',{bubbles:true})); } return; } if (opts.action === 'fillpad') { fillPad(field); updateA(); field.focus(); return; } if (field.value.length < maxLenFor(field)) { insertAtCaret(field, txt); updateA(); } field.focus(); }); return b; }
  '1234567890'.split('').forEach(k => keypadEl.appendChild(makeKey(k))); function addBreak() { const br = document.createElement('div'); br.className = 'break'; keypadEl.appendChild(br); } addBreak(); 'QWERTYUIOP'.split('').forEach(k => keypadEl.appendChild(makeKey(k))); addBreak(); 'ASDFGHJKL'.split('').forEach(k => keypadEl.appendChild(makeKey(k))); const bsKey = makeKey('', { label: 'Backspace', action: 'back' }); bsKey.innerHTML = '<i class="bi bi-backspace"></i>'; keypadEl.appendChild(bsKey); addBreak(); 'ZXCVBNM'.split('').forEach(k => keypadEl.appendChild(makeKey(k))); keypadEl.appendChild(makeKey('<', { label: 'Less-than', action: 'lt' })); keypadEl.appendChild(makeKey('FILL<', { span: 2, action: 'fillpad', label: '残りを < で埋める / Fill remaining with <' })); addBreak(); toggleBtn = document.getElementById('toggleKeypad'); if (toggleBtn) { toggleBtn.addEventListener('change', () => { keypadMode = toggleBtn.checked; applyKeypadMode(); }); } applyKeypadMode(); setCount(line1, l1count); updateA();
  const clearL1Btn = document.getElementById('clearL1Btn'); const checkL1Btn = document.getElementById('checkL1Btn'); let lastValidatedL1 = '';
  // Input中はエラー非表示。Validateボタン押下時のみ検証。
  line1.addEventListener('input', () => {
    if (!checkedL1) {
      errLine1.innerHTML = '';
      if (l1valid) l1valid.classList.remove('show');
    } else {
      if (l1valid && l1valid.classList.contains('show')) {
        l1valid.classList.remove('show');
      }
    }
  });
  if (checkL1Btn) {
    checkL1Btn.addEventListener('click', () => {
      if(errLine1){ errLine1.classList.remove('neutral'); }
      line1ErrorsLocked = false;
      const len = line1.value.length;
      const step1State = document.getElementById('step1State');
      const setStep1State = (type) => {
        if(!step1State) return;
        if(!type){ step1State.innerHTML=''; return; }
        if(type==='ok') step1State.innerHTML=' <span class="state-icon-wrap"><i class="bi bi-check"></i></span>';
        else if(type==='err') step1State.innerHTML=' <span class="state-icon-wrap err"><i class="bi bi-exclamation-lg"></i></span>';
      };
      if (len < 44) {
        errLine1.classList.remove('neutral');
        errLine1.innerHTML = '<ul class="errorlist"><li>Please enter 44 characters.</li></ul>';
        showBadge(errLine1,'error');
        checkedL1 = true;
        if(statusA){ statusA.textContent=''; statusA.classList.remove('ok','warn','error'); statusA.setAttribute('hidden',''); }
        lastValidatedL1='';
        line1ErrorsLocked = true;
        setStep1State('err');
        return;
      }
      checkedL1 = true;
      const errs = validateLine1Only(line1.value, { suppressLengthErrors: false });
      errLine1.classList.remove('neutral');
      errLine1.innerHTML = errs.length ? '<ul class="errorlist">' + errs.map(e => `<li>${e}</li>`).join('') + '</ul>' : '';
      if(errs.length){ showBadge(errLine1,'error'); lastValidatedL1=''; line1ErrorsLocked = true; if(statusA){ statusA.textContent=''; statusA.setAttribute('hidden',''); } setStep1State('err'); }
      else { lastValidatedL1 = line1.value; line1ErrorsLocked = false; if(statusA){ statusA.innerHTML = '<span class="msg-icon"><i class="bi bi-check-circle-fill" style="color:#16a34a" aria-label="Valid"></i></span>No MRZ Line 1 format rule (ICAO Doc 9303) errors.'; statusA.className='l1-status ok'; statusA.removeAttribute('hidden'); } setStep1State('ok'); }
      if(typeof enableStepControls==='function') enableStepControls();
    });
  }
  if (clearL1Btn) { clearL1Btn.addEventListener('click', () => { line1.value = ''; errLine1.innerHTML = ''; line1ErrorsLocked = false; if (l1valid) { l1valid.classList.remove('show'); } if(statusA){ statusA.textContent=''; statusA.setAttribute('hidden',''); const ic=statusA.querySelector('.msg-icon'); if(ic) ic.remove(); } const step1State=document.getElementById('step1State'); if(step1State) step1State.innerHTML=''; setCount(line1, l1count); updateA(); line1.focus(); enableStepControls(); }); }

    // ===== Line 2 builder logic (isolated) =====
    (function(){
      // Utilities reusing global checkDigit / normalizeMRZ
      function toYYMMDD(d){
        if(!d || !/^\d{4}-\d{2}-\d{2}$/.test(d)) return null;
        const [Y,M,D] = d.split('-').map(Number);
        const dt = new Date(Date.UTC(Y, M-1, D));
        if (dt.getUTCFullYear()!==Y || (dt.getUTCMonth()+1)!==M || dt.getUTCDate()!==D) return null;
        return String(Y).slice(-2) + String(M).padStart(2,'0') + String(D).padStart(2,'0');
      }
      const az09 = s => normalizeMRZ(s).replace(/[^A-Z0-9<]/g,'');
      // DOM refs
      const b_passno=document.getElementById('b_passno');
  const b_passno_cd=document.getElementById('b_passno_cd');
      const b_nat=document.getElementById('b_nationality');
      const b_dob=document.getElementById('b_dob');
      const b_sex=document.getElementById('b_sex');
      const b_exp=document.getElementById('b_expiry');
  const b_opt=document.getElementById('b_opt'); // now static display
  const b_dob_cd=document.getElementById('b_dob_cd');
  const b_expiry_cd=document.getElementById('b_expiry_cd');
      const err_passno=document.getElementById('err_passno');
      const err_nat=document.getElementById('err_nat');
      const err_dob=document.getElementById('err_dob');
      const err_sex=document.getElementById('err_sex');
      const err_exp=document.getElementById('err_exp');
      const err_opt=document.getElementById('err_opt');
  const assembledL2=document.getElementById('assembledL2');
  statusB=document.getElementById('statusB');
      if(!b_passno) return; // safety guard if section removed

      function normAZ09(el,max){ el.value = az09(el.value).slice(0,max); }
      function buildLine2Parts(){
        const passRaw = az09(b_passno.value).slice(0,9).padEnd(9,'<');
        const cdPass = checkDigit(passRaw)??'?';
        const nat = az09(b_nat.value).slice(0,3).padEnd(3,'<');
        const dobRaw = toYYMMDD(b_dob.value)||'<<<<<<';
        const cdDob = checkDigit(dobRaw)??'?';
        const sex = (b_sex.value||'<').charAt(0);
        const expRaw = toYYMMDD(b_exp.value)||'<<<<<<';
        const cdExp = checkDigit(expRaw)??'?';
  const opt = '<'.repeat(15); // fixed optional filler
        const finalSrc = passRaw + cdPass + dobRaw + cdDob + expRaw + cdExp + opt;
        const cdFinal = checkDigit(finalSrc)??'?';
        const full = passRaw + cdPass + nat + dobRaw + cdDob + sex + expRaw + cdExp + opt + cdFinal;
        return {passRaw, cdPass, nat, dobRaw, cdDob, sex, expRaw, cdExp, opt, cdFinal, full};
      }
  function validateB(line2){
        const errs=[]; const per={pass:[],nat:[],dob:[],sex:[],exp:[],opt:[]};
        if(!/^[A-Z0-9<]{44}$/.test(line2)) errs.push('Line 2 must be 44 chars [A–Z, 0–9, <].');
        const passNum=line2.slice(0,9), cdPass=line2[9];
        const nat=line2.slice(10,13);
        const dob=line2.slice(13,19), cdDob=line2[19];
        const sex=line2[20];
        const exp=line2.slice(21,27), cdExp=line2[27];
        const opt=line2.slice(28,43), cdFinal=line2[43];
        // Passport number detailed validation
        const rawPassInput = b_passno ? b_passno.value : passNum.replace(/<+$/,'');
  // Required
  if(rawPassInput.length===0){ per.pass.push('Passport number is required.'); }
  // Length check (only when user has started typing but still incomplete)
  else if(rawPassInput.length<9){ per.pass.push('Enter 9 characters.'); }
        // Character set check (only evaluate actual typed part, ignore trailing < padding)
        if(rawPassInput.length>0 && /[^A-Z0-9]/.test(rawPassInput)){ per.pass.push('Passport number: only A–Z and 0–9 allowed.'); }
        // All placeholders (e.g. user never typed but system padded) should not raise mismatch but show guidance
        if(rawPassInput.length===0){ /* no message; leave empty until user starts */ }
        else if(/^<+$/.test(passNum)){ per.pass.push('Passport number cannot be all placeholders (<).'); }
        // Check digit comparison only when fully 9 chars typed and passes basic pattern
        if(rawPassInput.length===9 && /^[A-Z0-9]{9}$/.test(rawPassInput)){
          if(checkDigit(passNum)!==cdPass) per.pass.push('Passport# check digit mismatch.');
        }
  if(/^<+$/.test(nat)) per.nat.push('Nationality is required.');
  else if(!/^[A-Z]{3}$/.test(nat)) per.nat.push('Nationality must be 3 letters A–Z.');
  else if(nat === 'JPN') per.nat.push('Specified Skilled Worker Tests are not available for Japanese nationals.');
  if(dob==='<<<<<<') per.dob.push('Date of birth is required.');
  else if(checkDigit(dob)!==cdDob) per.dob.push('DOB check digit mismatch.');
  if(sex==='<' && (!b_sex || b_sex.value==='')) per.sex.push('Sex is required.');
  else if(!/^[MFX<]$/.test(sex)) per.sex.push('Sex must be M/F/X or <.');
  if(exp==='<<<<<<') per.exp.push('Expiry date is required.');
  else if(checkDigit(exp)!==cdExp) per.exp.push('Expiry check digit mismatch.');
  // Optional data rules: only A–Z 0–9 and '<'; '<' は末尾パディングのみ許容
  if(!/^[A-Z0-9<]{15}$/.test(opt)) per.opt.push('Optional data must be A–Z, 0–9 or < (max 15).');
  // 内部に < があり後続に英数字が続く場合は不正 (パディングは末尾のみ)
  if(/<[A-Z0-9]/.test(opt)) per.opt.push('Optional data: "<" may only appear at the end as padding.');
        const finalSrc=passNum+cdPass+dob+cdDob+exp+cdExp+opt;
        if(checkDigit(finalSrc)!==cdFinal) errs.push('Final check digit mismatch.');
        return {ok: errs.length===0 && Object.values(per).every(a=>a.length===0), errs, per};
      }
      function clearFieldErrors(){
        err_passno.innerHTML=''; err_nat.innerHTML=''; err_dob.innerHTML=''; err_sex.innerHTML=''; err_exp.innerHTML=''; err_opt.innerHTML='';
      }
      function renderFieldErrors(per){
        // 呼び出し側でfull時のみ使用
  // Plain text (no bullet) errors for Line2 passport number
  err_passno.innerHTML=per.pass.length?per.pass.join('\n'):'';
  const rawNat = b_nationality ? b_nationality.value : '';
  if(per.nat.length){ err_nat.innerHTML=per.nat.join('\n'); } else { err_nat.innerHTML=''; }
  err_dob.innerHTML=per.dob.length?per.dob.join('\n'):'';
  err_sex.innerHTML=per.sex.length?per.sex.join('\n'):'';
  err_exp.innerHTML=per.exp.length?per.exp.join('\n'):'';
  err_opt.innerHTML=per.opt && per.opt.length?per.opt.join('\n'):'';
      }
      function updateB(mode='soft'){
  // Keep errors visible after a full confirm until next full confirm
  if(typeof window.line2Validated==='undefined') window.line2Validated=false;
  normAZ09(b_passno,9); normAZ09(b_nat,3); // b_opt static
        const parts = buildLine2Parts();
        // パスポート番号CD表示更新
        if(b_passno_cd){
          if(b_passno.value.length===9){
            b_passno_cd.textContent = parts.cdPass;
            b_passno_cd.classList.add('ready');
            b_passno_cd.removeAttribute('data-empty');
          } else if(b_passno.value.length===0){
            b_passno_cd.textContent='–';
            b_passno_cd.classList.remove('ready');
            b_passno_cd.setAttribute('data-empty','1');
          } else {
            b_passno_cd.textContent='…';
            b_passno_cd.classList.remove('ready');
            b_passno_cd.setAttribute('data-empty','1');
          }
        }
        // DOB CD 表示
        if(b_dob_cd){
          if(b_dob.value && parts.dobRaw!=='<<<<<<'){
            b_dob_cd.textContent = parts.cdDob;
            b_dob_cd.classList.add('ready');
          } else if(!b_dob.value){
            b_dob_cd.textContent='–';
            b_dob_cd.classList.remove('ready');
          } else {
            b_dob_cd.textContent='…';
            b_dob_cd.classList.remove('ready');
          }
        }
        // Expiry CD 表示
        if(b_expiry_cd){
          if(b_exp.value && parts.expRaw!=='<<<<<<'){
            b_expiry_cd.textContent = parts.cdExp;
            b_expiry_cd.classList.add('ready');
          } else if(!b_exp.value){
            b_expiry_cd.textContent='–';
            b_expiry_cd.classList.remove('ready');
          } else {
            b_expiry_cd.textContent='…';
            b_expiry_cd.classList.remove('ready');
          }
        }
        // 組立表示 (チェックデジットをハイライト)
        const highlighted = parts.passRaw + '<span class="l2-cd-mark">' + parts.cdPass + '</span>' +
          parts.nat + parts.dobRaw + '<span class="l2-cd-mark">' + parts.cdDob + '</span>' +
          parts.sex + parts.expRaw + '<span class="l2-cd-mark">' + parts.cdExp + '</span>' +
          parts.opt + '<span class="l2-cd-mark">' + parts.cdFinal + '</span>';
        assembledL2.innerHTML = highlighted;
        const l2 = parts.full;
  // Strict completeness: all mandatory segment raw inputs filled to required length
  const passFilled = b_passno && b_passno.value.length === 9;
  const natFilled = b_nat && b_nat.value.length === 3;
  const dobFilled = b_dob && b_dob.value !== '';
  const sexFilled = b_sex && b_sex.value !== '';
  const expFilled = b_exp && b_exp.value !== '';
  // MRZ structural checks remain
  const structuralOk = !l2.includes('?') && l2.length === 44 && !/<<{6}/.test(l2.slice(13,19)) && !/<<{6}/.test(l2.slice(21,27));
  const complete = passFilled && natFilled && dobFilled && sexFilled && expFilled && structuralOk;
        const res=validateB(l2);
        if(mode==='full'){
          window.line2Validated=true;
          renderFieldErrors(res.per);
          // remove any existing icon
          const existIcon = statusB.querySelector('.msg-icon'); if(existIcon) existIcon.remove();
          statusB.removeAttribute('hidden');
          if(res.ok && complete){
            statusB.className='l2-status ok';
            statusB.textContent='No MRZ Line 2 format rule (ICAO Doc 9303) errors.';
            showBadge(statusB,'valid');
          } else {
            statusB.className='l2-status err';
            statusB.innerHTML = (res.errs.length?
              (res.errs.length?('Errors:\n'+res.errs.join('\n')):''):
              'Review the field errors and fix them.'
            );
            showBadge(statusB,'error');
          }
        } else {
          // soft update: do not clear existing field errors or status if we have already done a full validation
          if(!window.line2Validated){
            clearFieldErrors();
            const existIcon = statusB.querySelector('.msg-icon'); if(existIcon) existIcon.remove();
            statusB.textContent='';
            statusB.className='l2-status';
            statusB.setAttribute('hidden','');
          }
        }
  enableStepControls();
      }
      ['input','keyup'].forEach(ev=>{
  [b_passno,b_nat].forEach(el=>el.addEventListener(ev,()=>updateB('soft')));
        [b_dob,b_sex,b_exp].forEach(el=>el.addEventListener(ev,()=>updateB('soft')));
      });
  // date inputs: prevent manual typing/paste/drop
  [b_dob,b_exp].filter(Boolean).forEach(d=>{
    ['keydown','keypress','paste','drop'].forEach(ev=>d.addEventListener(ev,e=>e.preventDefault()));
  });
  // click anywhere in wrapper to open calendar
  document.querySelectorAll('.l2-field-wrap').forEach(wrap=>{
    const dateInput = wrap.querySelector('input[type=date]');
    if(!dateInput) return;
    wrap.style.cursor='pointer';
    wrap.addEventListener('click',e=>{
      // 一時的にreadonly解除して一部ブラウザでカレンダーを確実に開く
      const wasRO = dateInput.hasAttribute('readonly');
      if(wasRO) dateInput.removeAttribute('readonly');
      if(dateInput.showPicker){
        try { dateInput.showPicker(); }
        catch(_) { dateInput.dispatchEvent(new MouseEvent('mousedown',{bubbles:true})); dateInput.focus(); }
      } else {
        dateInput.focus(); dateInput.click();
      }
      // すぐに戻す（ユーザー入力防止）
      if(wasRO) setTimeout(()=>dateInput.setAttribute('readonly',''),0);
    });
  });
  // blur/changeでの即時フル検証は無効化（Validateボタンのみ）
  const validateBtn=document.getElementById('validateL2Btn');
  if(validateBtn){ validateBtn.addEventListener('click',()=>{ updateB('full'); enableStepControls(); const step2State=document.getElementById('step2State'); if(step2State && statusB){ if(statusB.classList.contains('ok')){ step2State.innerHTML=' <span class="state-icon-wrap"><i class="bi bi-check"></i></span>'; } else if(statusB.classList.contains('err')){ step2State.innerHTML=' <span class="state-icon-wrap err"><i class="bi bi-exclamation-lg"></i></span>'; } } }); }
      (function setDateBounds(){
        const t=new Date();
        const iso=`${t.getFullYear()}-${String(t.getMonth()+1).padStart(2,'0')}-${String(t.getDate()).padStart(2,'0')}`;
        if (b_dob) { b_dob.max = iso; b_dob.min = '1900-01-01'; }
        if (b_exp) { b_exp.min = iso; b_exp.max = '2099-12-31'; }
      })();
  updateB('soft'); // initial build (status hidden)
    })();

  // Line2 sample toggle logic (independent of builder)
    (function(){
  const toggleSampleNat = document.getElementById('toggleSampleNat');
  const sampleNatBody = document.getElementById('sampleNatBody');
  if(toggleSampleNat && sampleNatBody){
          toggleSampleNat.addEventListener('click',()=>{
            const hidden = sampleNatBody.hasAttribute('hidden');
            if(hidden){
              sampleNatBody.removeAttribute('hidden');
              toggleSampleNat.textContent='Hide guide';
              toggleSampleNat.setAttribute('aria-expanded','true');
            } else {
              sampleNatBody.setAttribute('hidden','');
              toggleSampleNat.textContent='Show guide';
              toggleSampleNat.setAttribute('aria-expanded','false');
            }
          });
        }
  })();

    // ===== Wizard Navigation Logic =====
  stepButtons = Array.from(document.querySelectorAll('.wiz-step-btn'));
  if(stepButtons[0]) stepButtons[0].classList.add('current');
  if(stepButtons[1]) { stepButtons[1].disabled = false; stepButtons[1].classList.add('ready'); }
  const step1El = document.getElementById('step1');
  const step2El = document.getElementById('step2');
  nextFromStep1 = document.getElementById('nextFromStep1');
  backToStep1 = document.getElementById('backToStep1');
  submitMrz = document.getElementById('submitMrz');
  const legacyReturn = document.getElementById('legacyReturn');
  const legacyNext = document.getElementById('legacyNext');
  const legacyNextStep1 = document.getElementById('legacyNextStep1');
  function isLine1Valid(){ return statusA && statusA.classList.contains('ok'); }
  function isLine2Valid(){ return statusB && statusB.classList.contains('ok'); }
    function setActiveStep(n){
      stepButtons.forEach(btn=>btn.classList.remove('current','ready'));
      if(n===1){
        step1El.classList.add('active'); step2El.classList.remove('active');
        stepButtons[0].classList.add('current');
  stepButtons[1].classList.add('ready'); stepButtons[1].disabled=false;
        stepButtons[0].setAttribute('aria-selected','true'); stepButtons[1].setAttribute('aria-selected','false');
      } else {
        step1El.classList.remove('active'); step2El.classList.add('active');
  stepButtons[0].classList.add('ready'); stepButtons[0].disabled=false;
  stepButtons[1].classList.add('current'); stepButtons[1].disabled=false;
        stepButtons[0].setAttribute('aria-selected','false'); stepButtons[1].setAttribute('aria-selected','true');
      }
      enableStepControls(); }
  // (enableStepControls already declared globally; keep call sites intact)
    stepButtons.forEach(btn=>{ btn.addEventListener('click',()=>{ if(btn.disabled) return; const step=parseInt(btn.dataset.step,10); setActiveStep(step); }); });
    if(nextFromStep1){ nextFromStep1.addEventListener('click',()=>{ if(nextFromStep1.disabled) return; setActiveStep(2); }); }
    if(backToStep1){ backToStep1.addEventListener('click',()=>{ setActiveStep(1); }); }
  if(submitMrz){ submitMrz.addEventListener('click',()=>{ if(submitMrz.disabled) return; alert('登録処理:\nLine1:'+line1.value+'\n'+document.getElementById('assembledL2').textContent); }); }
  // Legacy nav wiring
  if(legacyReturn){ legacyReturn.addEventListener('click',()=>{ setActiveStep(1); }); }
  // Simplified MOC Next behavior: always enabled; click triggers both line validations.
  if(legacyNext){
    legacyNext.disabled = false; // always clickable
    legacyNext.addEventListener('click',()=>{
      // Trigger Line1 validation if confirm button exists
      const checkL1Btn = document.getElementById('checkL1Btn');
      if(checkL1Btn) checkL1Btn.click();
      // Trigger Line2 full validation
      const validateL2Btn = document.getElementById('validateL2Btn');
      if(validateL2Btn) validateL2Btn.click();
      const l1Ok = statusA && statusA.classList.contains('ok');
      const l2Ok = statusB && statusB.classList.contains('ok');
      if(l1Ok && l2Ok){
        window.location.href = 'サンプル_ID取得_idPassportConfirm_JLFW.html';
      } else {
        alert('入力エラーがあります。各ラインのエラーメッセージを確認してください。');
      }
    });
  }
  // Remove Next gating logic: keep original enableStepControls minimal
  const _origEnable = enableStepControls;
  enableStepControls = function(){ _origEnable(); };
  if(legacyNextStep1){ legacyNextStep1.disabled = false; legacyNextStep1.addEventListener('click',()=>{ setActiveStep(2); }); }
    // Observe status changes for enabling controls
    const mo = new MutationObserver(enableStepControls);
    mo.observe(statusA,{childList:true,subtree:true});
    mo.observe(statusB,{childList:true,subtree:true});
    enableStepControls();
  </script>
</body>

</html>
